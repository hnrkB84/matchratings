<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HV71 Admin</title>
  <style>
    :root { --hv-blu:#0c2d6b; --hv-yel:#ffd200; --gap:14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:20px; background:#f7f8fb; color:#0c254a;}
    h1 { color: var(--hv-blu); margin-bottom: 4px; }
    h2 { margin-top:30px; color:#0c254a; }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); margin-top:var(--gap); }
    .row { display:flex; gap:var(--gap); flex-wrap:wrap; }
    label { display:block; font-weight:600; margin:6px 0 6px; }
    input, select, textarea { width:100%; padding:10px; border:1px solid #d7dbe7; border-radius:8px; background:#fbfcff;}
    button { background:var(--hv-blu); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
    button.secondary { background:#2e4786; }
    button.warn { background:#b60000; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#eef2ff; padding:2px 6px; border-radius:6px;}
    .help { color:#51608a; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; margin-right:6px; }
    .ok { color:#147a00; }
    .err { color:#b60000; font-weight:700;}
    .flex { display:flex; gap:10px; }
    #log { white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#0b1633; color:#cce6ff; padding:12px; border-radius:10px; max-height:240px; overflow:auto; }
  </style>
</head>
<body>
  <h1>HV71 – Admin</h1>
  <p class="help">Token sparas lokalt. Bas-URL: <small class="mono" id="base"></small></p>

  <div class="card">
    <div class="row">
      <div style="flex:1 1 280px">
        <label>Admin token</label>
        <input id="token" placeholder="x-admin-token" />
      </div>
      <div style="align-self:end">
        <button id="saveToken">Spara token</button>
        <button id="clearToken" class="secondary">Rensa</button>
      </div>
    </div>
    <small class="help">Tips: använd samma som env-var <strong>ADMIN_TOKEN</strong> på Render.</small>
  </div>

  <h2>Skapa match</h2>
  <div class="card">
    <div class="row">
      <div style="flex:1 1 180px">
        <label>Datum (YYYY-MM-DD)</label>
        <input id="m_date" placeholder="2025-09-10" />
      </div>
      <div style="flex:1 1 180px">
        <label>Motstånd</label>
        <input id="m_opp" placeholder="Frölunda" />
      </div>
      <div style="flex:1 1 120px">
        <label>Hemma?</label>
        <select id="m_home">
          <option value="1">Hemma</option>
          <option value="0">Borta</option>
        </select>
      </div>
      <div style="flex:1 1 160px">
        <label>Säsong</label>
        <input id="m_season" placeholder="2025/26" />
      </div>
      <div style="flex:1 1 160px">
        <label>Tävling</label>
        <input id="m_competition" placeholder="SHL" />
      </div>
      <div style="flex:1 1 160px">
        <label>Öppna röstning direkt?</label>
        <select id="m_open">
          <option value="1">Ja</option>
          <option value="0">Nej</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="createMatch">Skapa match</button>
      <div id="createMatchOut" class="pill"></div>
    </div>
  </div>

  <h2>Öppna/Stäng röstning</h2>
  <div class="card">
    <div class="row">
      <div style="flex:1 1 220px">
        <label>Match</label>
        <select id="matchSelect"></select>
      </div>
      <div style="align-self:end" class="flex">
        <button id="openVote">Öppna</button>
        <button id="closeVote" class="warn">Stäng</button>
      </div>
    </div>
    <small class="help">Du kan också sätta ett <em>closes_at</em> i din backend om du vill auto-stänga.</small>
  </div>

  <h2>Spelare (bulk-upsert)</h2>
  <div class="card">
    <label>Lista (JSON per rad eller enklare CSV: <em>nr;namn;pos</em>)</label>
    <textarea id="playersBulk" rows="6" placeholder='Exempel JSON:
{"jersey_number":30,"name":"Målvakt Ett","position":"G","active":1}
{"jersey_number":3,"name":"Back Ett","position":"D","active":1}
{"jersey_number":9,"name":"Forward Ett","position":"F","active":1}

Exempel CSV:
30;Målvakt Ett;G
3;Back Ett;D
9;Forward Ett;F'></textarea>
    <div class="row" style="margin-top:10px">
      <button id="upsertPlayers">Spara spelare</button>
      <div id="upsertOut" class="pill"></div>
    </div>
  </div>

  <h2>Sätt trupp för match</h2>
  <div class="card">
    <div class="row">
      <div style="flex:1 1 220px">
        <label>Match</label>
        <select id="rosterMatch"></select>
      </div>
      <div style="flex:1 1 420px">
        <label>Spelare (håll Ctrl/Cmd för fler)</label>
        <select id="playerMulti" multiple size="10" style="height:220px"></select>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="setRoster">Spara trupp</button>
      <div id="rosterOut" class="pill"></div>
    </div>
  </div>

  <h2>Export</h2>
  <div class="card">
    <div class="row">
      <div style="flex:1 1 180px">
        <label>Match</label>
        <select id="exportMatch"></select>
      </div>
      <div style="align-self:end" class="flex">
        <button id="dlAgg">Aggregat CSV</button>
        <button id="dlRatingsCSV">Ratings CSV</button>
        <button id="dlRatingsJSONL" class="secondary">Ratings JSONL</button>
      </div>
    </div>
    <small class="help">JSONL är perfekt för AI-analys. CSV funkar i Excel/Sheets.</small>
  </div>

  <h2>Logg</h2>
  <div class="card">
    <div id="log">redo…</div>
  </div>

  <script>
    const BASE = location.origin;
    document.getElementById('base').textContent = BASE;

    const $ = (id)=>document.getElementById(id);
    const log = (m)=>{ const el=$('log'); el.textContent += "\\n" + m; el.scrollTop = el.scrollHeight; };

    // TOKEN
    const TOKEN_KEY = 'hv_admin_token';
    const tokenInput = $('token');
    tokenInput.value = localStorage.getItem(TOKEN_KEY) || '';
    $('saveToken').onclick = ()=>{ localStorage.setItem(TOKEN_KEY, tokenInput.value.trim()); log('Token sparad.'); };
    $('clearToken').onclick = ()=>{ localStorage.removeItem(TOKEN_KEY); tokenInput.value=''; log('Token rensad.'); };

    const headers = ()=>({
      'Content-Type':'application/json',
      'x-admin-token': (localStorage.getItem(TOKEN_KEY)||'').trim()
    });

    // Helpers
    async function jfetch(url, opts={}) {
      const r = await fetch(url, opts);
      if (!r.ok) {
        const t = await r.text();
        throw new Error(`${r.status} ${r.statusText}: ${t}`);
      }
      return r.json();
    }
    function download(url, filename){
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
    }

    // Init dropdowns
    async function loadMatches() {
      const list = await jfetch(`${BASE}/api/matches`);
      for (const selId of ['matchSelect','rosterMatch','exportMatch']) {
        const sel = $(selId); sel.innerHTML = '';
        list.forEach(m => {
          const o = document.createElement('option');
          o.value = m.id; o.textContent = `${m.id} – ${m.date} vs ${m.opponent} ${m.home? '(H)':'(B)'}`;
          sel.appendChild(o);
        });
      }
      log(`Laddade ${list.length} matcher.`);
    }
    async function loadPlayers() {
      const list = await jfetch(`${BASE}/api/players`); // alla aktiva
      const sel = $('playerMulti'); sel.innerHTML='';
      list.forEach(p => {
        const o = document.createElement('option');
        o.value = p.id; o.textContent = `${p.jersey_number ?? '-'} ${p.name} (${p.position||'-'})`;
        sel.appendChild(o);
      });
      log(`Laddade ${list.length} spelare.`);
    }

    // Skapa match
    $('createMatch').onclick = async () => {
      try {
        const payload = {
          date: $('m_date').value.trim(),
          opponent: $('m_opp').value.trim(),
          home: $('m_home').value === '1',
          season: $('m_season').value.trim(),
          competition: $('m_competition').value.trim(),
          voting_open: $('m_open').value === '1',
          closes_at: null
        };
        const j = await jfetch(`${BASE}/api/admin/create-match`, {
          method:'POST', headers: headers(), body: JSON.stringify(payload)
        });
        $('createMatchOut').textContent = `Skapad: id ${j.id}`;
        log(`Match skapad med id=${j.id}`);
        await loadMatches();
      } catch(e){ $('createMatchOut').textContent=''; log('ERR skapa match: '+e.message); }
    };

    // Toggle voting
    $('openVote').onclick = ()=>toggleVoting(true);
    $('closeVote').onclick = ()=>toggleVoting(false);
    async function toggleVoting(open) {
      const id = parseInt($('matchSelect').value,10);
      try {
        await jfetch(`${BASE}/api/admin/toggle-voting`, {
          method:'POST', headers: headers(), body: JSON.stringify({ id, open, closes_at: null })
        });
        log(`Röstning ${open?'ÖPPNAD':'STÄNGD'} för match ${id}`);
      } catch(e){ log('ERR toggle voting: '+e.message); }
    }

    // Bulk-upsert players
    $('upsertPlayers').onclick = async () => {
  const raw0 = $('playersBulk').value;
  if (!raw0 || !raw0.trim()) { log('Ingen spelarlista.'); return; }
  try {
    let players = [];
    const raw = raw0.replace(/\r\n?/g, '\n').trim(); // normalisera radbrytningar

    if (raw.startsWith('[') && raw.endsWith(']')) {
      // JSON-array
      players = JSON.parse(raw);

    } else {
      // Dela upp rader robust
      const lines = raw.split('\n')
        .map(l => l.replace(/^\uFEFF?/, '').trim())     // ta bort BOM + trim
        .filter(l => l.length > 0);

      // Försök JSON Lines (en {…} per rad), tillåt ev. avslutande komma
      let parsedAsJsonLines = true;
      const jsonItems = [];
      for (const l of lines) {
        const clean = l.replace(/,+\s*$/, '');
        try { jsonItems.push(JSON.parse(clean)); } catch { parsedAsJsonLines = false; break; }
      }
      if (parsedAsJsonLines) {
        players = jsonItems;
      } else {
        // Semikolon-CSV: nr;namn;pos (tolerant mot extra mellanslag)
        players = lines.map(l => {
          const parts = l.split(';').map(s => s.trim());
          const [nr, name, pos] = [parts[0] || '', parts[1] || '', parts[2] || ''];
          return {
            jersey_number: nr ? Number(nr.replace(/\D/g,'')) : null,
            name,
            position: pos.toUpperCase() || null,
            active: 1
          };
        }).filter(p => p.name);
      }
    }

    if (!Array.isArray(players) || players.length === 0) throw new Error('Inget att spara');

    const j = await jfetch(`${BASE}/api/admin/bulk-upsert-players`, {
      method:'POST',
      headers: headers(),
      body: JSON.stringify({ players })
    });

    $('upsertOut').textContent = `Sparat: ${j.count} spelare`;
    log(`Bulk-upsert OK: ${j.count} st`);
    await loadPlayers(); // fyll listan till trupp-väljaren
  } catch(e){
    $('upsertOut').textContent = '';
    log('ERR upsert players: ' + e.message);
  }
};

    // Set roster
    $('setRoster').onclick = async () => {
      const match_id = parseInt($('rosterMatch').value,10);
      const sel = $('playerMulti');
      const ids = Array.from(sel.selectedOptions).map(o=>Number(o.value));
      try {
        const j = await jfetch(`${BASE}/api/admin/set-roster`, {
          method:'POST', headers: headers(), body: JSON.stringify({ match_id, player_ids: ids, dressed_default: 1 })
        });
        $('rosterOut').textContent = `Trupp sparad: ${j.count} spelare`;
        log(`Roster OK för match ${match_id}: ${j.count} st`);
      } catch(e){ $('rosterOut').textContent=''; log('ERR set roster: '+e.message); }
    };

    // Export
    $('dlAgg').onclick = ()=>{
      const id = $('exportMatch').value;
      download(`${BASE}/api/export/aggregates?match_id=${id}`, `aggregates_match_${id}.csv`);
      log('Export aggregat startad.');
    };
    $('dlRatingsCSV').onclick = ()=>{
      const id = $('exportMatch').value;
      download(`${BASE}/api/export/ratings?match_id=${id}`, `ratings_match_${id}.csv`);
      log('Export ratings CSV startad.');
    };
    $('dlRatingsJSONL').onclick = ()=>{
      const id = $('exportMatch').value;
      download(`${BASE}/api/export/ratings?match_id=${id}&format=jsonl`, `ratings_match_${id}.jsonl`);
      log('Export ratings JSONL startad.');
    };

    // Boot
    (async function boot(){
      try {
        await loadMatches();
        await loadPlayers();
        log('Admin redo ✔');
      } catch(e){ log('ERR boot: '+e.message); }
    })();
  </script>
</body>
</html>
