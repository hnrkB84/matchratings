<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HV71 ‚Äì Kedjor & PP1</title>
<style>
  :root{
    --hv-blue:#0a2240; --hv-yellow:#ffcb01; --ink:#e8eef6;
    --card:#0b1f3a; --card-strong:#0d1f3d;
    --pp-card:#0f264d; /* tydligt annorlunda f√∂r PP1 */
    --slot:#112949; --slot-b:#2f4a75; --chip:#0f2d58; --muted:#9fb3d9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--hv-blue);color:var(--ink);font-family:system-ui,-apple-system,Inter,Roboto,Segoe UI,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#09203b 0%,#0a2240 100%);border-bottom:1px solid rgba(255,255,255,.06);padding:12px 14px 10px}
  h1{margin:0 0 4px;color:var(--hv-yellow);font-size:1.35rem}
  .wrap{max-width:980px;margin:0 auto;padding:12px}

  .card{background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px;margin:12px 0;box-shadow:0 2px 0 rgba(0,0,0,.25)}
  .card h2{margin:0 0 8px;display:flex;gap:8px;align-items:center}
  .title-chip{
    display:inline-flex;align-items:center;gap:10px;background:var(--chip);
    border:1px solid rgba(255,255,255,.14);border-radius:999px;padding:8px 14px;
    color:#fff; font-weight:900; font-size:1.05rem; letter-spacing:.2px;
  }
  .title-chip .dot{
    width:26px;height:26px;border-radius:999px;background:var(--hv-yellow);color:#1c1500;
    font-weight:900;display:inline-flex;align-items:center;justify-content:center;
    box-shadow:0 1px 0 rgba(0,0,0,.25)
  }

  /* PP1: distinkt kort */
  .card.alt{
    background:var(--pp-card);
    border:1px solid rgba(255,255,255,.22);
    box-shadow:inset 0 0 0 2px rgba(255,203,1,.10);
    position:relative;
  }
  .card.alt::before{
    content:""; position:absolute; left:-1px; top:-1px; bottom:-1px; width:4px;
    background:linear-gradient(180deg,#ffd84a,#ffcb01); border-radius:12px 0 0 12px;
  }

  /* kollapsbar analys */
  details.collapsible{background:var(--card-strong);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:8px 10px}
  details.collapsible summary{
    cursor:pointer; list-style:none; user-select:none; font-weight:900; color:var(--hv-yellow);
    display:flex; gap:8px; align-items:center; margin:4px 0;
  }
  details.collapsible summary::-webkit-details-marker{display:none}
  .chev{display:inline-block; transition:transform .2s ease}
  details[open] .chev{transform:rotate(90deg)}
  .analysis{padding:6px 2px 2px 2px; line-height:1.45}
  .analysis h3{margin:10px 0 6px; font-size:1rem; color:#eaf2ff}
  .bullet{color:#7fb0ff}

  /* kompakt pool */
  .pool-controls{display:flex;justify-content:flex-end;margin-bottom:6px}
  .toggle{background:transparent;color:#cfe0ff;border:1px solid rgba(255,255,255,.16);padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700}
  .pool{display:flex;flex-wrap:wrap;gap:6px;max-height:120px;overflow:hidden;transition:max-height .2s ease}
  .pool.expanded{max-height:none}

  .chip{
    display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:#fff;
    border:1px solid rgba(255,255,255,.14);padding:6px 9px;border-radius:999px;cursor:pointer;user-select:none;font-size:.9rem;line-height:1
  }
  .chip .no{
    display:inline-block;min-width:22px;height:22px;line-height:22px;border-radius:999px;
    background:var(--hv-yellow); color:#1c1500; font-weight:900; font-size:.78rem; text-align:center;
    box-shadow:0 1px 0 rgba(0,0,0,.25);
  }
  .chip.selected{outline:2px solid var(--hv-yellow);box-shadow:0 0 0 2px rgba(255,203,1,.2) inset;border-color:var(--hv-yellow)}

  /* lines */
  .grid-lines{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){.grid-lines{grid-template-columns:1fr 1fr}}
  .line-card{background:var(--card-strong);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px}
  .line-title{margin:0 0 6px;color:var(--hv-yellow);font-weight:900;font-size:1.05rem}
  .slots{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .slot{
    height:50px;border:1px dashed var(--slot-b);background:var(--slot);
    border-radius:10px;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer
  }
  .slot.filled{border-style:solid;background:#0e2647}
  .role{position:absolute;top:6px;left:8px;font-size:.8rem;color:var(--hv-yellow);font-weight:800}
  .slot .inner{display:flex;align-items:center;gap:6px;font-weight:800}
  .slot .inner .no{
    min-width:22px;height:22px;line-height:22px;border-radius:999px;background:var(--hv-yellow);color:#1c1500;font-size:.78rem;text-align:center
  }
  .slot .remove{position:absolute;right:6px;top:6px;background:transparent;border:none;color:#b8c5db;font-size:18px;cursor:pointer}

  /* PP1 rink ‚Äì dekor bakom inneh√•llet, ingen overlap */
  .pp-rink{
    position:relative;
    padding:16px 14px 54px;
    border-radius:12px;
    background:linear-gradient(180deg,#163058 0%, #142b50 100%);
    border:1px solid rgba(255,255,255,.15);
    overflow:hidden;
  }
  .rink-decor,.goal-line,.net{
    position:absolute; pointer-events:none; z-index:0;
  }
  .rink-decor{inset:0;border-radius:12px;box-shadow:inset 0 0 0 2px rgba(255,255,255,.08)}
  .goal-line{left:12px;right:12px;bottom:36px;height:2px;background:rgba(255,255,255,.35)}
  .net{
    left:calc(50% - 18px);bottom:14px;width:36px;height:18px;
    border:2px solid rgba(255,255,255,.9);border-top:none;border-radius:0 0 6px 6px;
  }
  .net::after{
    content:'M√ÖL'; position:absolute; top:-18px; left:50%; transform:translateX(-50%);
    font-size:.7rem; color:#cfe0ff; opacity:.9;
  }
  .pp-content{position:relative; z-index:1;}
  .pp-grid{display:grid;grid-template-rows:auto auto auto;gap:10px}
  .pp-row{display:grid;gap:10px}
  .pp-row.top{grid-template-columns:1fr}
  .pp-row.mid{grid-template-columns:1fr 1fr 1fr}
  .pp-row.bot{grid-template-columns:1fr}
  .pp-slot label{display:block;font-size:.95rem;color:var(--hv-yellow);font-weight:900;margin-bottom:4px}
  select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#0e2445;color:#e5efff}
  optgroup[label]{color:#cfe0ff}

  /* buttons */
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{border:none;cursor:pointer;border-radius:10px;font-weight:800}
  .btn.primary{background:var(--hv-yellow);color:#1c1500;padding:12px 14px}
  .btn.ghost{background:transparent;color:#cfe0ff;border:1px solid rgba(255,255,255,.16);padding:10px 12px}
  a.btn{display:inline-flex;align-items:center;text-decoration:none}
  #outCard{display:none}
  pre{white-space:pre-wrap;background:#081833;border:1px solid rgba(255,255,255,.12);padding:10px;border-radius:10px;color:#cfe0ff;font-size:.85rem}

  /* iframe resultat */
  .results-frame{
    width:100%; height:520px; border:1px solid rgba(255,255,255,.12);
    border-radius:12px; background:#081833;
  }
</style>
</head>
<body>
<header><h1>Bygg kedjor & PP1</h1></header>

<div class="wrap">

  <!-- 0. Kedjeanalys (kollapsbar) -->
  <details class="collapsible card">
    <summary><span class="chev">‚ñ∂</span> Kedjeanalys</summary>
    <div class="analysis">
      <p class="bullet">üîπ <strong>Kedja 1: Rousek ‚Äì Kloos ‚Äì St√•l Lyren√§s</strong></p>
      <p><strong>Lukas Rousek</strong><br>0 po√§ng, CF% 43, PDO 95<br>F√•r runt 16 min/match men har sv√•rt att driva spelet.<br>Laget hamnar under press med honom p√• isen.</p>
      <p><strong>Justin Kloos</strong><br>2 TP, CF% 50, PDO 100<br>Stabil men inte b√§rande, PP-tid utan st√∂rre utdelning.<br>Neutral p√•verkan ‚Äì varken negativ eller tydligt drivande.</p>
      <p><strong>Oskar St√•l Lyren√§s</strong><br>0 po√§ng, CF% 40, PDO 95<br>Spelar runt 15 min/match, √§ven i PP.<br>Svagt spelm√§ssigt och ingen utdelning offensivt.</p>
      <p><em>Kedjan:</em> Har f√•tt mycket istid men skapar f√∂r lite. Negativa possession-siffror och ingen offensiv produktion g√∂r detta till den svagaste formationen hittills.</p>

      <p class="bullet">üîπ <strong>Kedja 2: Ang ‚Äì Johnsen ‚Äì Woods</strong></p>
      <p><strong>Jonathan Ang</strong><br>3 TP, CF% 60, PDO 104<br>Spelar mest av forwards (~19 min/match), i b√•de PP och PK.<br>Kedjans motor och den som driver spelet fram√•t.</p>
      <p><strong>Martin Johnsen</strong><br>2 TP, CF% 52, PDO 107<br>Spelar 14 min/match, anv√§nds i alla spelformer.<br>Bidrar b√•de med produktion och arbetsinsats i tv√• riktningar.</p>
      <p><strong>Riley Woods</strong><br>2 TP, CF% 53, PDO 108<br>15 min/match, PP-tid, vinner m√•nga tekningar (68 %).<br>Ger laget puckinnehav och kompletterar bra med Ang.</p>
      <p><em>Kedjan:</em> Den mest balanserade och framg√•ngsrika enheten. Alla tre har producerat, possession √§r stabilt och rollerna kompletterar varandra.</p>

      <p class="bullet">üîπ <strong>Kedja 3: Luoto ‚Äì Heponiemi ‚Äì Pasic</strong></p>
      <p><strong>Joona Luoto</strong><br>1 TP, CF% 64, PDO 88<br>N√§stan 20 min/match, PP + PK.<br>Statistiskt lagets b√§sta drivspelare, men l√•g utdelning p.g.a. otur.</p>
      <p><strong>Aleksi Heponiemi</strong><br>1 m√•l (PP), CF% 64, PDO 92<br>19:37/match, tung roll i PP.<br>Bra underliggande siffror men ineffektivitet i 5v5.</p>
      <p><strong>Nikola Pasic</strong><br>1 TP, CF% 55, PDO 84<br>16 min/match, spelar PP men inte levererat.<br>-4 i plus/minus, tyngre start √§n kedjekamraterna.</p>
      <p><em>Kedjan:</em> Tv√• starka spelmotorer (Luoto/Heponiemi) som driver spelet, men utdelningen kommer inte. Pasic √§r den svagare l√§nken men helheten ser lovande ut om effektiviteten kommer.</p>

      <p class="bullet">üîπ <strong>Kedja 4: Br√§nnstr√∂m ‚Äì Reber ‚Äì Ingberg Nilsson ‚Äì Tedenby (+ Lindstr√∂m)</strong></p>
      <p><strong>Isac Br√§nnstr√∂m</strong><br>1 TP, CF% 51, PDO 78<br>Spelar ~11 min/match.<br>Bidrar med stabilt spel men ineffektiviteten syns i l√•g PDO.</p>
      <p><strong>Jamiro Reber</strong><br>0 po√§ng, CF% 63, PDO 100<br>6‚Äì7 min/match.<br>Sm√• roller men mycket stark possession n√§r han v√§l spelar.</p>
      <p><strong>William Ignberg Nilsson</strong><br>0 po√§ng, knappt 7 min/match.<br>Begr√§nsad roll, liten p√•verkan.</p>
      <p><strong>Mattias Tedenby</strong><br>1 TP p√• 2 matcher, ~3 min/match.<br>Kort istid men har √§nd√• producerat lite.</p>
      <p><strong>Linus Lindstr√∂m</strong><br>B√∂rjade i en toppkedja, flyttades sedan ner.<br>Inga po√§ng, CF% 47, tekningar 42 %.<br>Har inte riktigt hittat r√§tt roll √§n.</p>
      <p><em>Kedjan:</em> Matchas sparsamt men Br√§nnstr√∂m och Reber sticker ut positivt i possession. Lindstr√∂m anv√§nds mer f√∂r att fylla ut √§n att driva.</p>

      <h3>üìä Samlad bild</h3>
      <ul>
        <li><strong>Kedja 2 (Ang‚ÄìJohnsen‚ÄìWoods)</strong> ‚Üí klart mest effektiv, b√•de produktion och starka underliggande siffror.</li>
        <li><strong>Kedja 3 (Luoto‚ÄìHeponiemi‚ÄìPasic)</strong> ‚Üí drivs av Luoto/Heponiemi, men ineffektiviteten g√∂r att utdelningen uteblivit.</li>
        <li><strong>Kedja 1 (Rousek‚ÄìKloos‚ÄìSt√•l Lyren√§s)</strong> ‚Üí svagast, negativt spel√∂vertag och ingen produktion trots mycket istid.</li>
        <li><strong>Kedja 4 (... + Lindstr√∂m)</strong> ‚Üí sm√• roller, men positiva signaler fr√•n Br√§nnstr√∂m och Reber.</li>
      </ul>
    </div>
  </details>

  <!-- 0b. Live-resultat (inb√§ddat) -->
  <div class="card">
    <h2><span class="title-chip"><span class="dot">R</span>Resultat ‚Äì kedjor (live)</span></h2>
    <iframe id="resultsFrame" class="results-frame" src="" loading="lazy" title="Resultat kedjor"></iframe>
  </div>

  <!-- A. POOL (forwards) -->
  <div class="card">
    <h2><span class="title-chip"><span class="dot">F</span>Forwards</span></h2>
    <div class="pool-controls"><button id="togglePool" class="toggle">Visa alla</button></div>
    <div id="pool-lines" class="pool" aria-label="Forwards till kedjor"></div>
  </div>

  <!-- B. KEDJORNA -->
  <div class="card">
    <h2><span class="title-chip"><span class="dot">K</span>Kedjor</span></h2>
    <div class="grid-lines">
      <div class="line-card" data-line="1">
        <p class="line-title">Kedja 1</p>
        <div class="slots">
          <div class="slot" data-pos="LW"><span class="role">LW</span></div>
          <div class="slot" data-pos="C"><span class="role">C</span></div>
          <div class="slot" data-pos="RW"><span class="role">RW</span></div>
        </div>
      </div>
      <div class="line-card" data-line="2">
        <p class="line-title">Kedja 2</p>
        <div class="slots">
          <div class="slot" data-pos="LW"><span class="role">LW</span></div>
          <div class="slot" data-pos="C"><span class="role">C</span></div>
          <div class="slot" data-pos="RW"><span class="role">RW</span></div>
        </div>
      </div>
      <div class="line-card" data-line="3">
        <p class="line-title">Kedja 3</p>
        <div class="slots">
          <div class="slot" data-pos="LW"><span class="role">LW</span></div>
          <div class="slot" data-pos="C"><span class="role">C</span></div>
          <div class="slot" data-pos="RW"><span class="role">RW</span></div>
        </div>
      </div>
      <div class="line-card" data-line="4">
        <p class="line-title">Kedja 4</p>
        <div class="slots">
          <div class="slot" data-pos="LW"><span class="role">LW</span></div>
          <div class="slot" data-pos="C"><span class="role">C</span></div>
          <div class="slot" data-pos="RW"><span class="role">RW</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- C. PP1 -->
  <div class="card alt">
    <h2><span class="title-chip"><span class="dot">P</span>PP1</span></h2>
    <div class="pp-rink">
      <div class="rink-decor"></div>
      <div class="goal-line"></div>
      <div class="net"></div>

      <div class="pp-content">
        <div class="pp-grid">
          <div class="pp-row top">
            <div class="pp-slot"><label for="pp-PNT">PNT (point, bl√•linjen)</label><select id="pp-PNT"></select></div>
          </div>
          <div class="pp-row mid">
            <div class="pp-slot"><label for="pp-LFL">LFL (v√§nster flank)</label><select id="pp-LFL"></select></div>
            <div class="pp-slot"><label for="pp-BUM">BUM (bumper, slott)</label><select id="pp-BUM"></select></div>
            <div class="pp-slot"><label for="pp-RFL">RFL (h√∂ger flank)</label><select id="pp-RFL"></select></div>
          </div>
          <div class="pp-row bot">
            <div class="pp-slot"><label for="pp-NET">NET (framf√∂r m√•l)</label><select id="pp-NET"></select></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- D. Actions -->
  <div class="actions">
    <button class="btn primary" id="submitBtn">Skicka</button>
    <button class="btn ghost" id="resetBtn">Rensa</button>
    <a class="btn ghost" id="liveLink" href="#" target="_blank" rel="noopener">Resultat just nu</a>
    <span id="status" class="muted"></span>
  </div>

  <!-- E. Demo-output (kan d√∂ljas n√§r du √§r live) -->
  <div class="card" id="outCard"><h2>Payload (demo)</h2><pre id="out"></pre></div>
</div>

<script>
  /* ===== Helper: match-id + fingerprint ===== */
  const qp = new URLSearchParams(location.search);
  const matchId = qp.get('match') || null; // till√•t fr√•nvaro av match-id

  function getFingerprint(){
    const KEY='hv71_fp';
    try{
      let v = localStorage.getItem(KEY);
      if(!v){ v = (crypto.randomUUID?.() || String(Math.random())).replace(/-/g,''); localStorage.setItem(KEY, v); }
      return v + ':' + (navigator.userAgent || '');
    }catch(_){ return (navigator.userAgent||'ua') + ':' + Date.now(); }
  }

  /* ===== Trupp (h√•rdkodat) ===== */
  const DEFENSE = [
    {no:38, name:'Olle Alsing', pos:'D'},
    {no:6,  name:'Karl Annborn', pos:'D'},
    {no:55, name:'Andreas Borgman', pos:'D'},
    {no:44, name:'Hugo Fransson', pos:'D'},
    {no:19, name:'Niklas Hansson', pos:'D'},
    {no:82, name:'Santeri Hatakka', pos:'D'},
    {no:8,  name:'Lucas Lagerberg Hoen', pos:'D'},
    {no:61, name:'Axel Rindell', pos:'D'},
  ];
  const FORWARDS = [
    {no:27, name:'Jonathan Ang', pos:'F'},
    {no:17, name:'Isac Br√§nnstr√∂m', pos:'F'},
    {no:91, name:'Aleksi Heponiemi', pos:'F'},
    {no:36, name:'Martin Johnsen', pos:'F'},
    {no:28, name:'Justin Kloos', pos:'F'},
    {no:16, name:'Linus Lindstr√∂m', pos:'F'},
    {no:46, name:'Joona Luoto', pos:'F'},
    {no:71, name:'William Nilsson Ignberg', pos:'F'},
    {no:96, name:'Nikola Pasic', pos:'F'},
    {no:9,  name:'Hugo Pettersson', pos:'F'},
    {no:39, name:'Jamiro Reber', pos:'F'},
    {no:70, name:'Lukas Rousek', pos:'F'},
    {no:40, name:'Oskar St√•l Lyren√§s', pos:'F'},
    {no:21, name:'Mattias Tedenby', pos:'F'},
    {no:41, name:'Riley Woods', pos:'F'},
  ];
  const makeId = (p)=>`p-${p.no}-${p.name.toLowerCase().replace(/[^a-z0-9]+/g,'-')}`;
  FORWARDS.forEach(p=>p.id=makeId(p));
  DEFENSE.forEach(p=>p.id=makeId(p));
  const SKATERS = [...FORWARDS, ...DEFENSE];

  /* ===== State ===== */
  const state = {
    selected: null,
    lines: {1:{LW:null,C:null,RW:null},2:{LW:null,C:null,RW:null},3:{LW:null,C:null,RW:null},4:{LW:null,C:null,RW:null}},
    pp1: {PNT:null,LFL:null,BUM:null,RFL:null,NET:null},
  };

  /* ===== Resultat-URL (utan query om inget id) ===== */
  function resultsUrl(){
    return matchId ? `/resultat-lines.html?match=${encodeURIComponent(matchId)}`
                   : `/resultat-lines.html`;
  }

  /* ===== Iframe: resultat-lines.html ===== */
  const resultsFrame = document.getElementById('resultsFrame');
  function setResultsSrc(){
    resultsFrame.src = resultsUrl();
  }
  setResultsSrc();

  /* ===== Pool (kompakt, ingen s√∂k) ===== */
  const poolEl = document.getElementById('pool-lines');
  const toggleEl = document.getElementById('togglePool');
  function chipHTML(p){return `<span class="no">${p.no}</span><span>${p.name}</span>`;}
  function renderPool(){
    poolEl.innerHTML='';
    FORWARDS.forEach(p=>{
      const b=document.createElement('button');
      b.className='chip'; b.type='button'; b.dataset.id=p.id; b.innerHTML=chipHTML(p);
      b.addEventListener('click', ()=>selectForward(p.id, b));
      poolEl.appendChild(b);
    });
    refreshPoolUsage();
  }
  function refreshPoolUsage(){
    const used = new Set(Object.values(state.lines).flatMap(o=>Object.values(o)).filter(Boolean));
    poolEl.querySelectorAll('.chip').forEach(c=>{
      c.classList.toggle('selected', state.selected===c.dataset.id);
      c.style.opacity = used.has(c.dataset.id) ? .65 : 1;
    });
  }
  function selectForward(id, el){
    const was = state.selected===id;
    state.selected = was ? null : id;
    poolEl.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected'));
    if(!was) el.classList.add('selected');
  }
  toggleEl.addEventListener('click', ()=>{
    poolEl.classList.toggle('expanded');
    toggleEl.textContent = poolEl.classList.contains('expanded') ? 'Visa f√§rre' : 'Visa alla';
  });

  /* ===== Kedjor interaktion ===== */
  function slotInner(p){return `<div class="inner"><span class="no">${p.no}</span><span>${p.name}</span></div><button class="remove" aria-label="Ta bort">√ó</button>`;}
  document.querySelectorAll('.line-card .slot').forEach(slot=>{
    slot.addEventListener('click', ()=>{
      const line = slot.closest('.line-card').dataset.line;
      const pos  = slot.dataset.pos;
      if(slot.classList.contains('filled')){
        state.lines[line][pos]=null;
        slot.classList.remove('filled'); slot.innerHTML=`<span class="role">${pos}</span>`;
        refreshPoolUsage(); return;
      }
      if(!state.selected){ return; }
      // ta bort om forward redan finns n√•gonstans
      for(const L of ['1','2','3','4']) for(const R of ['LW','C','RW']){
        if(state.lines[L][R]===state.selected){
          const other = document.querySelector(`.line-card[data-line="${L}"] .slot[data-pos="${R}"]`);
          state.lines[L][R]=null; other.classList.remove('filled'); other.innerHTML=`<span class="role">${R}</span>`;
        }
      }
      const p = FORWARDS.find(x=>x.id===state.selected);
      state.lines[line][pos]=p.id;
      slot.classList.add('filled'); slot.innerHTML=`<span class="role">${pos}</span>${slotInner(p)}`;
      slot.querySelector('.remove').addEventListener('click', ev=>{ev.stopPropagation();slot.click();});
      refreshPoolUsage();
    });
  });

  /* ===== PP1 dropdowns ===== */
  const ppIds = ['PNT','LFL','BUM','RFL','NET'];
  const selects = Object.fromEntries(ppIds.map(id=>[id, document.getElementById('pp-'+id)]));
  function buildPPSelects(){
    ppIds.forEach(id=>{
      const sel = selects[id];
      sel.innerHTML='';
      sel.appendChild(new Option('‚Äì V√§lj spelare ‚Äì',''));
      const ogF = document.createElement('optgroup'); ogF.label='Forwards';
      FORWARDS.forEach(p=>ogF.appendChild(new Option(`${p.no} ${p.name}`, p.id)));
      const ogD = document.createElement('optgroup'); ogD.label='Backar';
      DEFENSE.forEach(p=>ogD.appendChild(new Option(`${p.no} ${p.name}`, p.id)));
      sel.appendChild(ogF); sel.appendChild(ogD);
      sel.addEventListener('change', ()=>{
        // hindra dublett i PP-roller
        const chosen = ppIds.map(k=>selects[k].value).filter(Boolean);
        const set = new Set(chosen);
        if(set.size !== chosen.length){
          alert('Samma spelare kan inte ha tv√• PP1-roller.');
          sel.value='';
        }
      });
    });
  }

  /* ===== POST: fallback-kedja n√§r match-id saknas ===== */
  async function postLinesVote(body){
    const endpoints = [];
    if (matchId) {
      endpoints.push(`/api/match/${encodeURIComponent(matchId)}/lines-vote`);
    } else {
      endpoints.push(`/api/match/current/lines-vote`);
      endpoints.push(`/api/lines-vote`);
    }
    let lastErr;
    for (const url of endpoints) {
      try {
        const resp = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data?.error || `HTTP ${resp.status}`);
        return data;
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error('Ingen fungerande endpoint hittades');
  }

  /* ===== Actions + POST ===== */
  const statusEl = document.getElementById('status');
  function setStatus(s){statusEl.textContent=s||'';}

  // "Resultat just nu" ‚Äì √∂ppnar resultat-sidan i ny flik
  const liveLink = document.getElementById('liveLink');
  liveLink.href = resultsUrl();

  if (!matchId) {
    setStatus('Ingen match i URL: sparar till aktiv match och visar live-resultat utan filter.');
  }

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    state.selected=null;
    for(const L of ['1','2','3','4']) for(const R of ['LW','C','RW']) state.lines[L][R]=null;
    document.querySelectorAll('.line-card .slot').forEach(s=>{const r=s.dataset.pos;s.classList.remove('filled');s.innerHTML=`<span class="role">${r}</span>`;});
    ppIds.forEach(id=>selects[id].value='');
    renderPool();
    document.getElementById('outCard').style.display='none';
    setStatus('√Öterst√§llt.');
  });

  document.getElementById('submitBtn').addEventListener('click', async ()=>{
    // validering
    for(const L of ['1','2','3','4']){
      const filled = Object.values(state.lines[L]).filter(Boolean).length;
      if(filled!==3){ alert(`Fyll tre spelare i Kedja ${L}.`); return; }
    }
    for(const id of ppIds){ if(!selects[id].value){ alert('V√§lj alla PP1-roller.'); return; } }

    // payload
    const payload = { lines:{}, pp1:[], scratch:[] };
    for(const L of ['1','2','3','4']){
      payload.lines[L] = ['LW','C','RW'].map(role=>{
        const pid = state.lines[L][role];
        const p = FORWARDS.find(x=>x.id===pid);
        return {pos:role,id:pid,name:p.name,jersey:p.no};
      });
    }
    ppIds.forEach(role=>{
      const pid = selects[role].value;
      const p = SKATERS.find(x=>x.id===pid);
      payload.pp1.push({role,id:pid,name:p.name,jersey:p.no,position:p.pos});
    });
    const usedFwd = new Set(Object.values(state.lines).flatMap(o=>Object.values(o)));
    payload.scratch = FORWARDS.filter(p=>!usedFwd.has(p.id)).map(p=>({id:p.id,name:p.name,jersey:p.no}));

    const body = {
      anon_fingerprint: getFingerprint(),
      ...payload
    };

    // visa lokalt (kan tas bort)
    document.getElementById('out').textContent = JSON.stringify({match_id:matchId ?? 'current', ...body}, null, 2);
    document.getElementById('outCard').style.display='block';

    // POST med fallback
    try{
      await postLinesVote(body);
      setStatus('‚úÖ Tack! R√∂sten √§r sparad.');
      setResultsSrc(); // uppdatera live-resultat
    }catch(e){
      console.error(e);
      setStatus('‚ùå Kunde inte spara. F√∂rs√∂k igen om en stund.');
      alert('Kunde inte spara r√∂stningen: ' + e.message);
    }
  });

  // init
  renderPool();
  buildPPSelects();
</script>
</body>
</html>
