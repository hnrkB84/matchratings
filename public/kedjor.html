<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HV71 ‚Äì Kedjor & PP1</title>

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:locale" content="sv_SE">
<meta property="og:title" content="HV71 ‚Äì Kedjor & PP1 (R√∂sta p√• dina formationer)">
<meta property="og:description" content="Bygg dina kedjor och PP1 f√∂r HV71 och skicka din r√∂st.">
<meta property="og:url" content="https://matchratings.onrender.com/kedjor.html">
<meta property="og:image" content="https://matchratings.onrender.com/kedjorog.jpeg">
<meta property="og:image:alt" content="HV71 ‚Äì Bygg kedjor & PP1">
<meta property="og:image:type" content="image/jpeg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="HV71 ‚Äì Kedjor & PP1 (R√∂sta p√• dina formationer)">
<meta name="twitter:description" content="Bygg dina kedjor och PP1 f√∂r HV71 och skicka din r√∂st.">
<meta name="twitter:image" content="https://matchratings.onrender.com/kedjorog.jpeg">
<meta name="twitter:url" content="https://matchratings.onrender.com/kedjor.html">

<link rel="canonical" href="https://matchratings.onrender.com/kedjor.html">

<style>
  :root{
    --hv-blue:#0a2240; --hv-yellow:#ffcb01; --ink:#e8eef6;
    --card:#0b1f3a; --card-strong:#0d1f3d;
    --pp-card:#0f264d;
    --slot:#112949; --slot-b:#2f4a75; --chip:#0f2d58; --muted:#9fb3d9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--hv-blue);color:var(--ink);font-family:system-ui,-apple-system,Inter,Roboto,Segoe UI,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#09203b 0%,#0a2240 100%);border-bottom:1px solid rgba(255,255,255,.06);padding:12px 14px 10px}
  h1{margin:0 0 4px;color:var(--hv-yellow);font-size:1.35rem}
  .wrap{max-width:980px;margin:0 auto;padding:12px}

  .card{background:var(--card);border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px;margin:12px 0;box-shadow:0 2px 0 rgba(0,0,0,.25)}
  .card h2{margin:0 0 8px;display:flex;gap:8px;align-items:center}
  .title-chip{
    display:inline-flex;align-items:center;gap:10px;background:var(--chip);
    border:1px solid rgba(255,255,255,.14);border-radius:999px;padding:8px 14px;
    color:#fff; font-weight:900; font-size:1.05rem; letter-spacing:.2px;
  }
  .title-chip .dot{
    width:26px;height:26px;border-radius:999px;background:var(--hv-yellow);color:#1c1500;
    font-weight:900;display:inline-flex;align-items:center;justify-content:center;
    box-shadow:0 1px 0 rgba(0,0,0,.25)
  }

  /* liten instruktion */
  .hint{background:var(--card-strong);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px;color:#cfe0ff;font-size:.95rem}
  .hint b{color:#ffdc4d}

  /* kollapsbar analys */
  details.collapsible{background:var(--card-strong);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:8px 10px}
  details.collapsible summary{
    cursor:pointer; list-style:none; user-select:none; font-weight:900; color:#fff;
    display:flex; gap:8px; align-items:center; margin:4px 0;
  }
  details.collapsible summary::-webkit-details-marker{display:none}
  .chev{display:inline-block; transition:transform .2s ease}
  details[open] .chev{transform:rotate(90deg)}
  .analysis{padding:6px 2px 2px 2px; line-height:1.45}
  .analysis p{margin:6px 0}

  /* pool */
  .pool-controls{display:flex;justify-content:flex-end;margin-bottom:6px}
  .toggle{background:transparent;color:#cfe0ff;border:1px solid rgba(255,255,255,.16);padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:700}
  .pool{display:flex;flex-wrap:wrap;gap:6px;max-height:120px;overflow:hidden;transition:max-height .2s ease}
  .pool.expanded{max-height:none}

  .chip{
    display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:#fff;
    border:1px solid rgba(255,255,255,.14);padding:6px 9px;border-radius:999px;cursor:pointer;user-select:none;font-size:.9rem;line-height:1
  }
  .chip .no{
    display:inline-block;min-width:22px;height:22px;line-height:22px;border-radius:999px;
    background:var(--hv-yellow); color:#1c1500; font-weight:900; font-size:.78rem; text-align:center;
    box-shadow:0 1px 0 rgba(0,0,0,.25);
  }
  .chip.selected{outline:2px solid var(--hv-yellow);box-shadow:0 0 0 2px rgba(255,203,1,.2) inset;border-color:var(--hv-yellow)}

  /* lines */
  .grid-lines{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:720px){.grid-lines{grid-template-columns:1fr 1fr}}
  .line-card{background:var(--card-strong);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px}
  .line-title{margin:0 0 6px;color:var(--hv-yellow);font-weight:900;font-size:1.05rem}
  .slots{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .slot{
    height:50px;border:1px dashed var(--slot-b);background:var(--slot);
    border-radius:10px;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer
  }
  .slot.filled{border-style:solid;background:#0e2647}
  .role{position:absolute;top:6px;left:8px;font-size:.8rem;color:#ffdc4d;font-weight:800}
  .slot .inner{display:flex;align-items:center;gap:6px;font-weight:800}
  .slot .inner .no{
    min-width:22px;height:22px;line-height:22px;border-radius:999px;background:var(--hv-yellow);color:#1c1500;font-size:.78rem;text-align:center
  }
  .slot .remove{position:absolute;right:6px;top:6px;background:transparent;border:none;color:#b8c5db;font-size:18px;cursor:pointer}

  /* PP1 */
  .card.alt{background:var(--pp-card);border:1px solid rgba(255,255,255,.22);box-shadow:inset 0 0 0 2px rgba(255,203,1,.10);position:relative;}
  .card.alt::before{content:""; position:absolute; left:-1px; top:-1px; bottom:-1px; width:4px;background:linear-gradient(180deg,#ffd84a,#ffcb01); border-radius:12px 0 0 12px;}
  .pp-rink{position:relative;padding:16px 14px 54px;border-radius:12px;background:linear-gradient(180deg,#163058 0%, #142b50 100%);border:1px solid rgba(255,255,255,.15);overflow:hidden;}
  .rink-decor,.goal-line,.net{position:absolute; pointer-events:none; z-index:0;}
  .rink-decor{inset:0;border-radius:12px;box-shadow:inset 0 0 0 2px rgba(255,255,255,.08)}
  .goal-line{left:12px;right:12px;bottom:36px;height:2px;background:rgba(255,255,255,.35)}
  .net{left:calc(50% - 18px);bottom:14px;width:36px;height:18px;border:2px solid rgba(255,255,255,.9);border-top:none;border-radius:0 0 6px 6px;}
  .net::after{content:'M√ÖL'; position:absolute; top:-18px; left:50%; transform:translateX(-50%);font-size:.7rem; color:#cfe0ff; opacity:.9;}
  .pp-content{position:relative; z-index:1;}
  .pp-grid{display:grid;grid-template-rows:auto auto auto;gap:10px}
  .pp-row{display:grid;gap:10px}
  .pp-row.top{grid-template-columns:1fr}
  .pp-row.mid{grid-template-columns:1fr 1fr 1fr}
  .pp-row.bot{grid-template-columns:1fr}
  .pp-slot label{display:block;font-size:.95rem;color:#ffdc4d;font-weight:900;margin-bottom:4px}
  select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#0e2445;color:#e5efff}
  optgroup[label]{color:#cfe0ff}

  /* buttons */
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{border:none;cursor:pointer;border-radius:10px;font-weight:800}
  .btn.primary{background:var(--hv-yellow);color:#1c1500;padding:12px 14px}
  .btn.ghost{background:transparent;color:#cfe0ff;border:1px solid rgba(255,255,255,.16);padding:10px 12px}
  a.btn{display:inline-flex;align-items:center;text-decoration:none}
  #outCard{display:none}
  pre{white-space:pre-wrap;background:#081833;border:1px solid rgba(255,255,255,.12);padding:10px;border-radius:10px;color:#cfe0ff;font-size:.85rem}
</style>
</head>
<body>
<header><h1>Bygg kedjor & PP1</h1></header>

<div class="wrap">

  <!-- Kort, enkel instruktion -->
  <div class="hint">
    <b>S√• h√§r g√∂r du:</b> Tryck p√• <b>spelaren</b> du vill anv√§nda, tryck sedan p√• <b>positionen</b> i r√§tt kedja. V√§lj PP1 via rullistorna. Tryck <b>Skicka</b> f√∂r att spara (du kan √§ndra n√§r som helst).
  </div>

  <!-- Kedjeanalys -->
  <details class="collapsible card">
    <summary><span class="chev">‚ñ∂</span> Kedjeanalys</summary>
    <div class="analysis">
      <p><b>Rousek ‚Äì Kloos ‚Äì (Lindstr√∂m) ‚Äì St√•l-Lyren√§s:</b> Kedjan har topp-6-f√∂rtroende men n√§stan ingen 5v5-produktion. Lindstr√∂ms fr√•nvaro och rollbyte har r√∂rt om, men framf√∂r allt saknas m√•lchanser som oms√§tts i po√§ng.</p>
      <p><b>Ang ‚Äì Johnsen ‚Äì Woods:</b> Ska vara en b√§rande offensiv kedja men levererar inte i 5v5. Ang spelar n√§rmast 20 min per match utan att skapa utdelning ‚Äì ett tydligt exempel p√• toppkedjornas problem.</p>
      <p><b>Luoto ‚Äì Heponiemi ‚Äì Pasic:</b> F√•r mest istid i hela laget men producerar lika lite som de andra toppformationerna. Det ser mer ut som en effektivitetsdipp √§n att de inte kan skapa, men resultatet √§r √§nd√• att kedjan inte driver HV71 fram√•t.</p>
      <p><b>Br√§nnstr√∂m ‚Äì Reber ‚Äì Ingberg Nilsson ‚Äì Tedenby:</b> Fj√§rdekedjan spelar lite och p√•verkar inte helheten. H√§r finns inget st√∂rre problem ‚Äì men de kan inte v√§ga upp n√§r toppkedjorna inte levererar.</p>
      <p><b>üëâ Huvudproblemet:</b> HV71:s toppkedjor producerar inte i 5v5 trots stort f√∂rtroende och mycket istid. N√§r PP inte heller b√§r fullt ut blir det naturligt att laget hamnar i en f√∂rlustsvit.</p>
    </div>
  </details>

  <!-- A. POOL (forwards) -->
  <div class="card">
    <h2><span class="title-chip"><span class="dot">F</span>Forwards</span></h2>
    <div class="pool-controls"><button id="togglePool" class="toggle">Visa alla</button></div>
    <div id="pool-lines" class="pool" aria-label="Forwards till kedjor"></div>
  </div>

  <!-- B. KEDJORNA -->
  <div class="card">
    <h2><span class="title-chip"><span class="dot">K</span>Kedjor</span></h2>
    <div class="grid-lines">
      <div class="line-card" data-line="1">
        <p class="line-title">Kedja 1</p>
        <div class="slots">
          <div class="slot" data-pos="LW"><span class="role">LW</span></div>
          <div class="slot" data-pos="C"><span class="role">C</span></div>
          <div class="slot" data-pos="RW"><span class="role">RW</span></div>
        </div>
      </div>
      <div class="line-card" data-line="2">
        <p class="line-title">Kedja 2</p>
        <div class="slots">
          <div class="slot" data-pos="LW"><span class="role">LW</span></div>
          <div class="slot" data-pos="C"><span class="role">C</span></div>
          <div class="slot" data-pos="RW"><span class="role">RW</span></div>
        </div>
      </div>
      <div class="line-card" data-line="3">
        <p class="line-title">Kedja 3</p>
        <div class="slots">
          <div class="slot" data-pos="LW"><span class="role">LW</span></div>
          <div class="slot" data-pos="C"><span class="role">C</span></div>
          <div class="slot" data-pos="RW"><span class="role">RW</span></div>
        </div>
      </div>
      <div class="line-card" data-line="4">
        <p class="line-title">Kedja 4</p>
        <div class="slots">
          <div class="slot" data-pos="LW"><span class="role">LW</span></div>
          <div class="slot" data-pos="C"><span class="role">C</span></div>
          <div class="slot" data-pos="RW"><span class="role">RW</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- C. PP1 -->
  <div class="card alt">
    <h2><span class="title-chip"><span class="dot">P</span>PP1</span></h2>
    <div class="pp-rink">
      <div class="rink-decor"></div>
      <div class="goal-line"></div>
      <div class="net"></div>

      <div class="pp-content">
        <div class="pp-grid">
          <div class="pp-row top">
            <div class="pp-slot"><label for="pp-PNT">PNT (point, bl√•linjen)</label><select id="pp-PNT"></select></div>
          </div>
          <div class="pp-row mid">
            <div class="pp-slot"><label for="pp-LFL">LFL (v√§nster flank)</label><select id="pp-LFL"></select></div>
            <div class="pp-slot"><label for="pp-BUM">BUM (bumper, slott)</label><select id="pp-BUM"></select></div>
            <div class="pp-slot"><label for="pp-RFL">RFL (h√∂ger flank)</label><select id="pp-RFL"></select></div>
          </div>
          <div class="pp-row bot">
            <div class="pp-slot"><label for="pp-NET">NET (framf√∂r m√•l)</label><select id="pp-NET"></select></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- D. Actions -->
  <div class="actions">
    <button class="btn primary" id="submitBtn">Skicka</button>
    <button class="btn ghost" id="resetBtn">Rensa</button>
    <a class="btn ghost" id="liveLink" href="#" target="_blank" rel="noopener">Visa resultat</a>
    <button class="btn ghost" id="shareBtn" type="button" title="Dela den h√§r sidan">Dela sidan</button>
    <span id="status" class="muted"></span>
  </div>

  <!-- E. Demo-output (kan d√∂ljas n√§r du √§r live) -->
  <div class="card" id="outCard"><h2>Payload (demo)</h2><pre id="out"></pre></div>
</div>

<script>
  /* ===== Query & fingerprint ===== */
  const qp = new URLSearchParams(location.search);
  const matchId = qp.get('match') || null;

  function getFingerprint(){
    const KEY='hv71_fp';
    try{
      let v = localStorage.getItem(KEY);
      if(!v){ v = (crypto.randomUUID?.() || String(Math.random())).replace(/-/g,''); localStorage.setItem(KEY, v); }
      return v + ':' + (navigator.userAgent || '');
    }catch(_){ return (navigator.userAgent||'ua') + ':' + Date.now(); }
  }

  /* ===== Trupp (h√•rdkodat) ===== */
  const DEFENSE = [
    {no:38, name:'Olle Alsing', pos:'D'},
    {no:6,  name:'Karl Annborn', pos:'D'},
    {no:55, name:'Andreas Borgman', pos:'D'},
    {no:44, name:'Hugo Fransson', pos:'D'},
    {no:19, name:'Niklas Hansson', pos:'D'},
    {no:82, name:'Santeri Hatakka', pos:'D'},
    {no:8,  name:'Lucas Lagerberg Hoen', pos:'D'},
    {no:61, name:'Axel Rindell', pos:'D'},
  ];
  const FORWARDS = [
    {no:27, name:'Jonathan Ang', pos:'F'},
    {no:17, name:'Isac Br√§nnstr√∂m', pos:'F'},
    {no:91, name:'Aleksi Heponiemi', pos:'F'},
    {no:36, name:'Martin Johnsen', pos:'F'},
    {no:28, name:'Justin Kloos', pos:'F'},
    {no:16, name:'Linus Lindstr√∂m', pos:'F'},
    {no:46, name:'Joona Luoto', pos:'F'},
    {no:71, name:'William Nilsson Ignberg', pos:'F'},
    {no:96, name:'Nikola Pasic', pos:'F'},
    {no:9,  name:'Hugo Pettersson', pos:'F'},
    {no:39, name:'Jamiro Reber', pos:'F'},
    {no:70, name:'Lukas Rousek', pos:'F'},
    {no:40, name:'Oskar St√•l Lyren√§s', pos:'F'},
    {no:21, name:'Mattias Tedenby', pos:'F'},
    {no:41, name:'Riley Woods', pos:'F'},
  ];
  const makeId = (p)=>`p-${p.no}-${p.name.toLowerCase().replace(/[^a-z0-9]+/g,'-')}`;
  FORWARDS.forEach(p=>p.id=makeId(p));
  DEFENSE.forEach(p=>p.id=makeId(p));
  const SKATERS = [...FORWARDS, ...DEFENSE];

  /* ===== State ===== */
  const state = {
    selected: null,
    lines: {1:{LW:null,C:null,RW:null},2:{LW:null,C:null,RW:null},3:{LW:null,C:null,RW:null},4:{LW:null,C:null,RW:null}},
    pp1: {PNT:null,LFL:null,BUM:null,RFL:null,NET:null},
  };

  /* ===== Resultat-l√§nk ===== */
  function resultsUrl(){
    return matchId ? `/resultat-lines.html?match=${encodeURIComponent(matchId)}`
                   : `/resultat-lines.html`;
  }
  document.getElementById('liveLink').href = resultsUrl();

  /* ===== Pool ===== */
  const poolEl = document.getElementById('pool-lines');
  const toggleEl = document.getElementById('togglePool');
  function chipHTML(p){return `<span class="no">${p.no}</span><span>${p.name}</span>`;}
  function renderPool(){
    poolEl.innerHTML='';
    FORWARDS.forEach(p=>{
      const b=document.createElement('button');
      b.className='chip'; b.type='button'; b.dataset.id=p.id; b.innerHTML=chipHTML(p);
      b.addEventListener('click', ()=>selectForward(p.id, b));
      poolEl.appendChild(b);
    });
    refreshPoolUsage();
  }
  function refreshPoolUsage(){
    const used = new Set(Object.values(state.lines).flatMap(o=>Object.values(o)).filter(Boolean));
    poolEl.querySelectorAll('.chip').forEach(c=>{
      c.classList.toggle('selected', state.selected===c.dataset.id);
      c.style.opacity = used.has(c.dataset.id) ? .65 : 1;
    });
  }
  function selectForward(id, el){
    const was = state.selected===id;
    state.selected = was ? null : id;
    poolEl.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected'));
    if(!was) el.classList.add('selected');
  }
  toggleEl.addEventListener('click', ()=>{
    poolEl.classList.toggle('expanded');
    toggleEl.textContent = poolEl.classList.contains('expanded') ? 'Visa f√§rre' : 'Visa alla';
  });

  /* ===== Kedjor interaktion ===== */
  function slotInner(p){return `<div class="inner"><span class="no">${p.no}</span><span>${p.name}</span></div><button class="remove" aria-label="Ta bort">√ó</button>`;}
  document.querySelectorAll('.line-card .slot').forEach(slot=>{
    slot.addEventListener('click', ()=>{
      const line = slot.closest('.line-card').dataset.line;
      const pos  = slot.dataset.pos;
      if(slot.classList.contains('filled')){
        state.lines[line][pos]=null;
        slot.classList.remove('filled'); slot.innerHTML=`<span class="role">${pos}</span>`;
        refreshPoolUsage(); return;
      }
      if(!state.selected){ return; }
      // ta bort om forward redan finns n√•gonstans
      for(const L of ['1','2','3','4']) for(const R of ['LW','C','RW']){
        if(state.lines[L][R]===state.selected){
          const other = document.querySelector(`.line-card[data-line="${L}"] .slot[data-pos="${R}"]`);
          state.lines[L][R]=null; other.classList.remove('filled'); other.innerHTML=`<span class="role">${R}</span>`;
        }
      }
      const p = FORWARDS.find(x=>x.id===state.selected);
      state.lines[line][pos]=p.id;
      slot.classList.add('filled'); slot.innerHTML=`<span class="role">${pos}</span>${slotInner(p)}`;
      slot.querySelector('.remove').addEventListener('click', ev=>{ev.stopPropagation();slot.click();});
      refreshPoolUsage();
    });
  });

  /* ===== PP1 dropdowns ===== */
  const ppIds = ['PNT','LFL','BUM','RFL','NET'];
  const selects = Object.fromEntries(ppIds.map(id=>[id, document.getElementById('pp-'+id)]));
  function buildPPSelects(){
    ppIds.forEach(id=>{
      const sel = selects[id];
      sel.innerHTML='';
      sel.appendChild(new Option('‚Äì V√§lj spelare ‚Äì',''));
      const ogF = document.createElement('optgroup'); ogF.label='Forwards';
      FORWARDS.forEach(p=>ogF.appendChild(new Option(`${p.no} ${p.name}`, p.id)));
      const ogD = document.createElement('optgroup'); ogD.label='Backar';
      DEFENSE.forEach(p=>ogD.appendChild(new Option(`${p.no} ${p.name}`, p.id)));
      sel.appendChild(ogF); sel.appendChild(ogD);
      sel.addEventListener('change', ()=>{
        const chosen = ppIds.map(k=>selects[k].value).filter(Boolean);
        const set = new Set(chosen);
        if(set.size !== chosen.length){
          alert('Samma spelare kan inte ha tv√• PP1-roller.');
          sel.value='';
        }
      });
    });
  }

  /* ===== POST (stand-alone + match-aware) ===== */
  async function postLinesVote(body){
    const endpoints = [];
    if (!matchId) {
      endpoints.push(`/api/lines-vote`);
      endpoints.push(`/api/match/current/lines-vote`); // legacy fallback
    } else {
      endpoints.push(`/api/match/${encodeURIComponent(matchId)}/lines-vote`);
      endpoints.push(`/api/lines-vote`);
    }
    let lastErr;
    for (const url of endpoints) {
      try {
        const resp = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data?.error || `HTTP ${resp.status}`);
        return data;
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error('Ingen fungerande endpoint hittades');
  }

  /* ===== Actions ===== */
  const statusEl = document.getElementById('status');
  function setStatus(s){statusEl.textContent=s||'';}

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    state.selected=null;
    for(const L of ['1','2','3','4']) for(const R of ['LW','C','RW']) state.lines[L][R]=null;
    document.querySelectorAll('.line-card .slot').forEach(s=>{const r=s.dataset.pos;s.classList.remove('filled');s.innerHTML=`<span class="role">${r}</span>`;});
    ppIds.forEach(id=>selects[id].value='');
    renderPool();
    document.getElementById('outCard').style.display='none';
    setStatus('√Öterst√§llt.');
  });

  document.getElementById('submitBtn').addEventListener('click', async ()=>{
    for(const L of ['1','2','3','4']){
      const filled = Object.values(state.lines[L]).filter(Boolean).length;
      if(filled!==3){ alert(`Fyll tre spelare i Kedja ${L}.`); return; }
    }
    for(const id of ppIds){ if(!selects[id].value){ alert('V√§lj alla PP1-roller.'); return; } }

    const payload = { lines:{}, pp1:[], scratch:[] };
    for(const L of ['1','2','3','4']){
      payload.lines[L] = ['LW','C','RW'].map(role=>{
        const pid = state.lines[L][role];
        const p = FORWARDS.find(x=>x.id===pid);
        return {pos:role,id:pid,name:p.name,jersey:p.no};
      });
    }
    ppIds.forEach(role=>{
      const pid = selects[role].value;
      const p = SKATERS.find(x=>x.id===pid);
      payload.pp1.push({role,id:pid,name:p.name,jersey:p.no,position:p.pos});
    });
    const usedFwd = new Set(Object.values(state.lines).flatMap(o=>Object.values(o)));
    payload.scratch = FORWARDS.filter(p=>!usedFwd.has(p.id)).map(p=>({id:p.id,name:p.name,jersey:p.no}));

    const body = { anon_fingerprint: getFingerprint(), ...payload };

    document.getElementById('out').textContent = JSON.stringify({match_id:matchId ?? 'standalone', ...body}, null, 2);
    document.getElementById('outCard').style.display='block';

    try{
      await postLinesVote(body);
      setStatus('‚úÖ Tack! R√∂sten √§r sparad.');
    }catch(e){
      console.error(e);
      setStatus('‚ùå Kunde inte spara. F√∂rs√∂k igen om en stund.');
      alert('Kunde inte spara r√∂stningen: ' + e.message);
    }
  });

  // Share
  const shareBtn = document.getElementById('shareBtn');
  shareBtn.addEventListener('click', async ()=>{
    const url = location.href;
    const title = document.title;
    const text = 'Bygg dina HV71-kedjor & PP1 och r√∂sta h√§r:';
    try{
      if(navigator.share){
        await navigator.share({title, text, url});
        setStatus('Delad ‚úî');
      }else{
        await navigator.clipboard.writeText(url);
        setStatus('L√§nk kopierad ‚úî');
        shareBtn.textContent = 'L√§nk kopierad';
        setTimeout(()=>{shareBtn.textContent='Dela sidan'; setStatus('');}, 2000);
      }
    }catch(e){
      setStatus('Kunde inte dela.');
    }
  });

  // init
  renderPool();
  buildPPSelects();
</script>
</body>
</html>
