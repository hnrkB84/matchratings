<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HV71 – Resultat: Kedjor & PP1</title>
<style>
  :root{
    --hv-blue:#0a2240; --hv-yellow:#ffcb01; --ink:#e8eef6;
    --card:#0b1f3a; --card-strong:#0d1f3d; --muted:#9fb3d9;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--hv-blue);color:var(--ink);font-family:system-ui,-apple-system,Inter,Roboto,Segoe UI,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#09203b 0%,#0a2240 100%);
    border-bottom:1px solid rgba(255,255,255,.06);padding:12px 14px 10px}
  h1{margin:0 0 2px;color:var(--hv-yellow);font-size:1.3rem}
  .sub{margin:0;color:#bdd1f6;font-weight:600;font-size:.95rem}
  .wrap{max-width:980px;margin:0 auto;padding:12px}

  /* Share bar */
  .sharebar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 14px}
  .btn{border:none;cursor:pointer;border-radius:10px;font-weight:800}
  .btn.primary{background:var(--hv-yellow);color:#1c1500;padding:10px 12px}
  .btn.ghost{background:transparent;color:#cfe0ff;border:1px solid rgba(255,255,255,.16);padding:10px 12px}
  .muted{color:#9fb3d9}
  .ok{color:#b6ffb3}
  .err{color:#ffd1d1}

  .row{display:grid;gap:12px}
  @media(min-width:780px){.row.two{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:12px;box-shadow:0 2px 0 rgba(0,0,0,.25)}
  .card h2{margin:0 0 10px;color:var(--hv-yellow);font-size:1.05rem}

  /* Lines grid */
  .grid-lines{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:760px){.grid-lines{grid-template-columns:1fr 1fr}}
  .line-card{background:var(--card-strong);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:12px}
  .line-title{margin:0 10px 8px;color:#ffdc4d;font-weight:900}

  /* Compact slots */
  .pos-row{display:grid;grid-template-columns:64px 1fr;gap:8px;align-items:center;padding:6px 8px;border-radius:10px}
  .pos-row + .pos-row{margin-top:6px}
  .pos-tag{font-size:.8rem;color:#cfe0ff;opacity:.9}
  .slot{
    display:flex;align-items:center;gap:8px;background:#0f2d58;border:1px solid rgba(255,255,255,.12);
    border-radius:999px;padding:8px 10px;font-weight:800
  }
  .jersey{min-width:22px;height:22px;line-height:22px;text-align:center;background:var(--hv-yellow);
    color:#1c1500;border-radius:999px;font-weight:900;font-size:.78rem}
  .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* details (optional) */
  details{margin-top:6px}
  details summary{cursor:pointer;color:#cfe0ff;font-size:.9rem}
  .alt-list{margin:6px 0 0 0;padding:0;list-style:none}
  .alt-list li{display:flex;align-items:center;gap:8px;margin:4px 0;color:#cfe0ff}
  .alt-list .count{margin-left:auto;opacity:.8}

  /* PP grid */
  .pp-grid{display:grid;gap:12px}
  @media(min-width:760px){.pp-grid{grid-template-columns:repeat(5,1fr)}}
  .pp-role{background:var(--card-strong);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:12px}
  .pp-role h3{margin:0 0 6px;color:#ffdc4d;font-size:.95rem}

  .scratch-list{margin:0;padding:0;list-style:none}
  .scratch-list li{display:flex;gap:8px;align-items:center;margin:4px 0}
</style>
</head>
<body>
  <header>
    <h1>Resultat – Kedjor & PP1</h1>
    <p class="sub">Sammanställning av röstning</p>
  </header>

  <div class="wrap">
    <!-- Share / Länkar -->
    <div class="sharebar">
      <button id="shareVoteBtn"   class="btn primary">Dela röstningssidan</button>
      <button id="copyVoteBtn"    class="btn ghost">Kopiera länk (röstning)</button>
      <button id="shareResultBtn" class="btn primary">Dela resultatsidan</button>
      <button id="copyResultBtn"  class="btn ghost">Kopiera länk (resultat)</button>
      <a class="btn ghost" href="https://matchratings.onrender.com/kedjor.html" target="_blank" rel="noopener">Öppna röstningssidan</a>
      <span id="shareMsg" class="muted"></span>
    </div>

    <div class="row">
      <div class="card">
        <h2>Kedjor</h2>
        <div id="lines" class="grid-lines"></div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h2>PP1</h2>
        <div id="pp1" class="pp-grid"></div>
      </div>
    </div>

    <div class="row two">
      <div class="card">
        <h2>Oanvända forwards (scratch)</h2>
        <ul id="scratch" class="scratch-list"></ul>
        <p class="muted" id="scratchNote">Visas om rådata innehåller scratch-val.</p>
      </div>
    </div>
  </div>

<script>
(() => {
  // Delningslänkar
  const VOTE_URL   = "https://matchratings.onrender.com/kedjor.html";
  const RESULT_URL = location.href;

  // Elements
  const linesEl        = document.getElementById('lines');
  const ppEl           = document.getElementById('pp1');
  const scratchEl      = document.getElementById('scratch');
  const shareVoteBtn   = document.getElementById('shareVoteBtn');
  const copyVoteBtn    = document.getElementById('copyVoteBtn');
  const shareResultBtn = document.getElementById('shareResultBtn');
  const copyResultBtn  = document.getElementById('copyResultBtn');
  const shareMsg       = document.getElementById('shareMsg');

  // Share helpers
  async function shareOrCopy(url, titleText, fallbackLabel){
    if (navigator.share) {
      try {
        await navigator.share({ title: document.title, text: titleText, url });
        shareMsg.textContent = 'Delat!';
        shareMsg.className = 'ok';
        setTimeout(()=>{ shareMsg.textContent=''; shareMsg.className='muted'; }, 3000);
        return;
      } catch { /* fall-through */ }
    }
    try {
      await navigator.clipboard.writeText(url);
      shareMsg.textContent = `${fallbackLabel} kopierad!`;
      shareMsg.className = 'ok';
    } catch {
      shareMsg.textContent = 'Kunde inte kopiera länken.';
      shareMsg.className = 'err';
    }
    setTimeout(()=>{ shareMsg.textContent=''; shareMsg.className='muted'; }, 3000);
  }

  shareVoteBtn.addEventListener('click', () => {
    shareOrCopy(VOTE_URL, 'Rösta på HV71-kedjor här', 'Röstningslänk');
  });
  copyVoteBtn.addEventListener('click', () => {
    shareOrCopy(VOTE_URL, '', 'Röstningslänk');
  });
  shareResultBtn.addEventListener('click', () => {
    shareOrCopy(RESULT_URL, 'Se resultat för HV71-kedjor här', 'Resultatlänk');
  });
  copyResultBtn.addEventListener('click', () => {
    shareOrCopy(RESULT_URL, '', 'Resultatlänk');
  });

  // ===== Databearbetning =====
  const qp = new URLSearchParams(location.search);
  const matchId = qp.get('match') || null;

  function blankAgg(){
    return {
      players: {}, // id -> {id,name,jersey,pos}
      lines: { '1':{LW:{},C:{},RW:{}}, '2':{LW:{},C:{},RW:{}}, '3':{LW:{},C:{},RW:{}}, '4':{LW:{},C:{},RW:{}} },
      pp1:   { PNT:{}, LFL:{}, BUM:{}, RFL:{}, NET:{} },
      scratch: {}
    };
  }
  function ensurePlayer(map, p){
    if(!p || !p.id) return;
    if(!map[p.id]) map[p.id] = { id:p.id, name:p.name, jersey:p.jersey, pos:p.position || p.pos || '?' };
  }

  function normalizeResponse(data){
    if (data && data.lines && data.pp1 && data.players) return data;
    return aggregateFromRaw(data);
  }
  function aggregateFromRaw(raw){
    const A = blankAgg();
    let votes = [];
    if (raw && Array.isArray(raw.votes)) {
      votes = raw.votes.map(row => {
        if (row && typeof row.payload_json === 'string') {
          try { return JSON.parse(row.payload_json); } catch { return null; }
        }
        return row || null;
      }).filter(Boolean);
    } else if (raw && Array.isArray(raw)) {
      votes = raw;
    } else if (raw && raw.lines && raw.pp1) {
      votes = [raw];
    }

    for (const v of votes) {
      if (v.lines) {
        for (const L of ['1','2','3','4']) {
          const arr = v.lines[L] || [];
          for (const pick of arr) {
            if (!pick || !pick.id || !pick.pos) continue;
            ensurePlayer(A.players, pick);
            A.lines[L][pick.pos] ??= {};
            A.lines[L][pick.pos][pick.id] = (A.lines[L][pick.pos][pick.id] || 0) + 1;
          }
        }
      }
      if (Array.isArray(v.pp1)) {
        for (const pick of v.pp1) {
          if (!pick || !pick.id || !pick.role) continue;
          ensurePlayer(A.players, pick);
          A.pp1[pick.role] ??= {};
          A.pp1[pick.role][pick.id] = (A.pp1[pick.role][pick.id] || 0) + 1;
        }
      }
      if (Array.isArray(v.scratch)) {
        for (const s of v.scratch) {
          if (!s || !s.id) continue;
          ensurePlayer(A.players, s);
          A.scratch[s.id] = (A.scratch[s.id] || 0) + 1;
        }
      }
    }
    return A;
  }

  // ===== Rendering (leader only + optional details) =====
  function entriesSorted(countMap, players){
    return Object.entries(countMap || {}).map(([id,c])=>({id, c, p:players[id]})).sort((a,b)=>b.c-a.c);
  }

  function renderLeaderSlot(holder, item){
    const row = document.createElement('div');
    row.className = 'slot';
    row.innerHTML = `
      <span class="jersey">${item.p?.jersey ?? '?'}</span>
      <span class="name">${item.p?.name ?? item.id}</span>
    `;
    holder.appendChild(row);
  }

  function renderTop3Details(holder, items){
    if (items.length <= 1) return;
    const det = document.createElement('details');
    det.innerHTML = `<summary>Visa topp 3</summary>`;
    const ul = document.createElement('ul');
    ul.className = 'alt-list';
    items.slice(0,3).forEach((it,idx)=>{
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="jersey">${it.p?.jersey ?? '?'}</span>
        <span>${it.p?.name ?? it.id}</span>
        <span class="count">${idx===0 ? 'vanligast' : ''}</span>
      `;
      ul.appendChild(li);
    });
    det.appendChild(ul);
    holder.appendChild(det);
  }

  function renderLines(A){
    linesEl.innerHTML='';
    for (const L of ['1','2','3','4']) {
      const card = document.createElement('div');
      card.className = 'line-card';
      card.innerHTML = `<p class="line-title">Kedja ${L}</p>`;

      ['LW','C','RW'].forEach(pos=>{
        const row = document.createElement('div');
        row.className = 'pos-row';
        row.innerHTML = `<div class="pos-tag">${pos}</div><div class="pos-holder"></div>`;
        const holder = row.querySelector('.pos-holder');

        const items = entriesSorted(A.lines[L][pos], A.players);
        if (items.length === 0){
          holder.innerHTML = `<span class="muted">—</span>`;
        } else {
          renderLeaderSlot(holder, items[0]);
          renderTop3Details(holder, items);
        }
        card.appendChild(row);
      });

      linesEl.appendChild(card);
    }
  }

  function renderPP(A){
    ppEl.innerHTML='';
    const roles = ['PNT','LFL','BUM','RFL','NET'];
    roles.forEach(role=>{
      const r = document.createElement('div');
      r.className = 'pp-role';
      r.innerHTML = `<h3>${role}</h3>`;
      const holder = document.createElement('div');

      const items = entriesSorted(A.pp1[role], A.players);
      if (items.length === 0){
        holder.innerHTML = `<span class="muted">—</span>`;
      } else {
        renderLeaderSlot(holder, items[0]);
        renderTop3Details(holder, items);
      }
      r.appendChild(holder);
      ppEl.appendChild(r);
    });
  }

  function renderScratch(A){
    scratchEl.innerHTML='';
    const entries = Object.entries(A.scratch || {}).map(([id,c])=>({id,c,p:A.players[id]})).sort((a,b)=>b.c-a.c);
    if (!entries.length) {
      scratchEl.innerHTML = '<li class="muted">Ingen scratch-data.</li>';
      return;
    }
    entries.forEach(it=>{
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="jersey">${it.p?.jersey ?? '?'}</span>
        <span>${it.p?.name ?? it.id}</span>
        <span class="muted" style="margin-left:auto">${it.c}×</span>
      `;
      scratchEl.appendChild(li);
    });
  }

  // ===== Fetch & init =====
  async function fetchResults(){
    const urls = [];
    if (matchId) urls.push(`/api/match/${encodeURIComponent(matchId)}/lines-results`);
    else { urls.push(`/api/lines-results`); urls.push(`/api/match/current/lines-results`); }
    let lastErr;
    for (const u of urls) {
      try{
        const r = await fetch(u, {cache:'no-store'});
        const data = await r.json();
        if(!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);
        return data;
      }catch(e){ lastErr=e; }
    }
    throw lastErr || new Error('Ingen fungerande results-endpoint hittades');
  }

  async function init(){
    try{
      const raw = await fetchResults();
      const A = normalizeResponse(raw);
      renderLines(A);
      renderPP(A);
      renderScratch(A);
    }catch(e){
      console.error(e);
      linesEl.innerHTML = `<div class="muted">Kunde inte hämta resultat: ${e.message}</div>`;
      ppEl.innerHTML    = '';
      scratchEl.innerHTML = '';
    }
  }

  init();
})();
</script>
</body>
</html>
